let files={},imports={},obs=[],events=[],exp={noDuplicateStyle:!1};const delay=e=>new Promise(t=>setTimeout(t,e));async function SFile(e){return new Promise((t,l)=>{files[e]?t(files[e]):fetch(e).then(async l=>{l=await l.text(),files[e]=l,t(l)})})}function SReplace(e,t){if(e.outerHTML)e.outerHTML=t;else{let l=document.createElement("div");l.innerHTML=t,(ObjParent=e.parentNode).replaceChild(l,e)}}function SGetSample(e,t){e[3]=e[3].slice(1,-1),Array.from(document.getElementsByTagName(e[1].slice(1,-1))).forEach(async l=>{for(let i=0;i<20;i++)imports[e[3]]||await delay(100);let n=imports[e[3]];if(n)l.getAttribute("var")&&l.getAttribute("var").split(";").map(e=>e.trim()).filter(e=>e.length>0).forEach(e=>{e=e.split(":"),n=n.replaceAll(`\${${e[0]}}`,e[1])}),"inject"===t?l.innerHTML=n:SReplace(l,n);else throw Error(e[3]+" was not defined when "+t+" loaded")})}function SUpdate(){if(exp.noDuplicateStyle){if(!document.getElementById("htms-style")){let style=document.createElement("style");style.id="htms-style",style.textContent="htms{display:none !important}",document.head.appendChild(style)}}else{let style=document.createElement("style");style.textContent="htms{display:none !important}",document.head.appendChild(style)}obs.length&&(obs.forEach(e=>{e.disconnect()}),events.forEach(e=>{e[0].removeEventListener("input",e[1])}));let SMainElem=document.querySelector("htms");if(!SMainElem){console.warn("HTMS was included but no config was detected");return}document.querySelectorAll("htms").length>1&&console.warn("Multiple htms elements provided, only the first one will take effect");let SConfig=SMainElem.innerHTML.split("\n").map(e=>e.trim()).filter(e=>e.length>0&&!e.startsWith("//"));for(let line of SConfig){let args=line.split(" ");switch(args[0]){case"import":if("from"!=args[2])throw Error('Import missing "from"');SFile(args[3].slice(1,-1)).then(e=>{args[1].split(",").map(e=>e.slice(1,-1)).forEach(t=>{let l=RegExp('<sample .*?name="'+t+'".*?>[^\xac]*?</sample>');imports[t]=e.match(l)[0].replaceAll(/<sample .+?>|<\/sample>/g,"").trim()})});break;case"inject":if("with"!=args[2])throw Error('Inject missing "with"');SGetSample(args,"inject");break;case"replace":if("with"!=args[2])throw Error('Replace missing "with"');SGetSample(args,"replace");break;case"module":SFile("https://htms.fsh.plus/module/"+args[1].slice(1,-1)+"/module.js").then(code=>eval(code));break;case"exp":exp[args[1]]=!0;break;default:throw Error(args[0]+" is not a valid action")}}let valueElements=["input","textarea","select"];Array.from(document.querySelectorAll("[htms-out]")).forEach(e=>{let t=e.tagName.toLowerCase(),l=()=>{let l=valueElements.includes(t)?e.value:e.innerHTML;document.querySelectorAll(`[htms-in="${e.getAttribute("htms-out")}"]`).forEach(e=>{valueElements.includes(e.tagName.toLowerCase())?e.value=l:e.innerHTML=l})},i=new MutationObserver(l);i.observe(e,{attributes:!0,childList:!0,subtree:!0}),obs.push(i),e.addEventListener("input",l),events.push([e,l])}),document.dispatchEvent(new Event("SLoad",{bubbles:!0}))}function SRemoveCache(){files={},imports={}}document.addEventListener("DOMContentLoaded",SUpdate),window.htms={version:4,update:SUpdate,removeCache:SRemoveCache};
